<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyNETHUB</title>

  <style>
    /* =========================================================
       SAFETY + SCALING WRAPPER
       - Everything is scoped to .mnh-app (safe for any website)
       - Your variables are unchanged (same values you set)
       - Only scaling improvements were added
    ========================================================= */

    .mnh-app{
      /* =========================
         Theme + Global (YOUR VALUES)
      ========================= */
      --bg: #020617;              /* slate-950 */
      --panel: rgba(15,23,42,.55);/* slate-ish glass */
      --panelSolid: #0b1220;
      --border: rgba(148,163,184,.18);
      --border2: rgba(148,163,184,.28);
      --text: #e5e7eb;
      --muted: rgba(229,231,235,.6);
      --muted2: rgba(229,231,235,.4);

      --radius-lg: 2px;
      --radius-md: 2px;
      --radius-sm: 2px;

      --shadow: 0 24px 60px rgba(0,0,0,.55);

      /* Library controls (YOUR VALUES) */
      --maxw: 2000px;
      --cols: 4;
      --gapX: 15px;
      --gapY: 25px;
      --thumbRadius: 10px;

      /* ✅ Scaling helpers (NEW but doesn't change your look) */
      --padX: clamp(16px, 2vw, 24px);
      --padY: clamp(16px, 2vw, 24px);
      --cardMin: 260px; /* used only for auto-fit fallback */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .mnh-app, .mnh-app *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; }

    .mnh-app{
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    .mnh-app a{ color: inherit; text-decoration:none; }
    .mnh-app button, .mnh-app input{ font: inherit; color: inherit; }
    .mnh-app button{ cursor:pointer; }

    /* =========================
       Header (YouTube-like)
    ========================= */
    .mnh-app .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--border);
      background: rgba(2,6,23,.82);
      backdrop-filter: blur(10px);
    }
    .mnh-app .wrap{
      max-width: var(--maxw);
      margin: 0 auto;

      /* ✅ responsive padding without changing desktop look */
      padding: 12px var(--padX);

      display:flex;
      align-items:center;
      gap: 14px;
    }
    .mnh-app .brand{
      min-width: 180px;
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 20px;
    }

    /* Search */
    .mnh-app .searchWrap{
      flex:1;
      display:flex;
      justify-content:center;
      min-width: 0;
    }
    .mnh-app .searchRow{
      width: 100%;
      max-width: 720px;
      display:flex;
      align-items:center;
      min-width: 0;
    }
    .mnh-app .searchInput{
      width:100%;
      border: 1px solid rgba(148,163,184,.35);
      background: #020617;
      padding: 10px 14px;
      border-right: none;
      border-top-left-radius: 999px;
      border-bottom-left-radius: 999px;
      outline: none;
      font-size: 14px;
      min-width: 0;
    }
    .mnh-app .searchInput:focus{
      border-color: rgba(203,213,225,.55);
    }
    .mnh-app .searchBtn{
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.7);
      padding: 10px 14px;
      border-top-right-radius: 999px;
      border-bottom-right-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }
    .mnh-app .searchBtn:hover{ background: rgba(15,23,42,.95); }

    /* Right actions */
    .mnh-app .actions{
      min-width: 320px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 12px;
      position: relative;
      flex: 0 0 auto;
    }

    .mnh-app .pill{
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.65);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      white-space: nowrap;
    }
    .mnh-app .pill:hover{ background: rgba(15,23,42,.92); }

    .mnh-app .link{
      font-size: 14px;
      color: rgba(229,231,235,.8);
      white-space: nowrap;
    }
    .mnh-app .link:hover{ color: #fff; }

    .mnh-app .profile{
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display:grid;
      place-items:center;
      font-weight: 800;
      font-size: 13px;
      background: rgba(126,34,206,.7);
      border: 1px solid rgba(148,163,184,.35);
      flex: 0 0 auto;
    }

    /* Create dropdown */
    .mnh-app .menu{
      position:absolute;
      right:0;
      top: 48px;
      width: 260px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.96);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
    }
    .mnh-app .menu.show{ display:block; }
    .mnh-app .menuItem{
      width:100%;
      border: none;
      background: transparent;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      gap: 12px;
      font-size: 14px;
      text-align:left;
    }
    .mnh-app .menuItem:hover{ background: rgba(15,23,42,.8); }
    .mnh-app .menuIcon{
      width: 34px; height: 34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background: rgba(15,23,42,.8);
      border: 1px solid var(--border);
    }

    /* =========================
       Main + Library
    ========================= */
    .mnh-app .main{
      max-width: var(--maxw);
      margin: 0 auto;

      /* ✅ responsive padding only */
      padding: var(--padY) var(--padX);
    }

    .mnh-app .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 18px;
      gap: 12px;
    }
    .mnh-app .sectionTitle{
      font-size: 26px;
      font-weight: 800;
      letter-spacing:-0.02em;
    }
    .mnh-app .count{
      font-size: 14px;
      color: rgba(229,231,235,.6);
      white-space: nowrap;
    }

    /* ✅ Auto-scale grid without changing your desktop look */
    .mnh-app .grid{
      display:grid;
      column-gap: var(--gapX);
      row-gap: var(--gapY);
      grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
    }

    /* When the viewport/container is smaller, auto-fit prevents broken layouts */
    @media (max-width: 1100px){
      .mnh-app .grid{
        grid-template-columns: repeat(auto-fit, minmax(min(100%, var(--cardMin)), 1fr));
      }
    }

    .mnh-app .card{ cursor:pointer; user-select:none; }
    .mnh-app .thumb{
      position:relative;
      aspect-ratio: 16 / 9;
      border-radius: var(--thumbRadius);
      overflow:hidden;
      background:#000;
      border: 1px solid rgba(148,163,184,.25);
      transition: all .18s ease;
    }
    .mnh-app .thumb img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .mnh-app .card:hover .thumb{
      border-color: rgba(203,213,225,.55);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
    }
    .mnh-app .title{
      margin-top: 14px;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.35;
      color: rgba(229,231,235,.95);
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .mnh-app .empty{
      display:none;
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(15,23,42,.35);
      padding: 18px;
      color: rgba(229,231,235,.65);
    }
    .mnh-app .empty.show{ display:block; }

    /* =========================================================
       ✅ FIXED RESPONSIVE COLUMNS (YouTube-like)
       - Big phones: 2 columns
       - Small phones: 1 column
    ========================================================= */
    @media (max-width: 1280px){
      .mnh-app{ --cols: 3; }
    }
    @media (max-width: 900px){
      .mnh-app{ --cols: 2; }
      .mnh-app .wrap{ padding:12px 16px; }
      .mnh-app .main{ padding:16px; }
    }
    /* Big phones */
    @media (max-width: 680px){
      .mnh-app{ --cols: 2; }
    }
    /* Small phones */
    @media (max-width: 420px){
      .mnh-app{
        --cols: 1;
        --gapX: 18px;
        --gapY: 22px;
      }
      .mnh-app .brand{ min-width:auto; }
      .mnh-app .actions{ min-width:auto; }
    }

    /* ✅ Extra safety for tiny screens: wrap header actions */
    @media (max-width: 760px){
      .mnh-app .actions{ min-width: 0; }
      .mnh-app .wrap{ flex-wrap: wrap; row-gap: 10px; }
      .mnh-app .brand{ min-width: auto; }
    }

    /* =========================
       Modals
    ========================= */
    .mnh-app .modal{
      position: fixed;
      inset: 0;
      z-index: 50;
      display:none;
    }
    .mnh-app .modal.show{ display:block; }
    .mnh-app .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.7);
    }
    .mnh-app .modalCenter{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: clamp(12px, 2vw, 24px);
    }
    .mnh-app .dialog{
      width: 100%;
      border-radius: 28px;
      background: #222;
      border: 1px solid rgba(255,255,255,.1);
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: 92vh;
      display:flex;
      flex-direction:column;
    }
    .mnh-app .dialog.wide{ max-width: 1100px; }
    .mnh-app .dialog.mid{ max-width: 920px; }

    .mnh-app .dialogTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }
    .mnh-app .dialogTitle{
      font-size: 18px;
      font-weight: 700;
    }
    .mnh-app .iconBtn{
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border:none;
      background: transparent;
      display:grid;
      place-items:center;
    }
    .mnh-app .iconBtn:hover{ background: rgba(255,255,255,.08); }

    .mnh-app .dialogBodyScroll{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .mnh-app .dropZone{
      min-height: 420px;
      margin: 18px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background:#2a2a2a;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 30px;
    }
    .mnh-app .dropZone.drag{
      outline: 2px solid rgba(255,255,255,.25);
      outline-offset: 4px;
    }
    .mnh-app .bigCircle{
      width: 112px; height:112px;
      border-radius: 999px;
      background: rgba(0,0,0,.4);
      display:grid;
      place-items:center;
      margin-bottom: 18px;
    }
    .mnh-app .primary{
      margin-top: 18px;
      border: none;
      background: #fff;
      color:#000;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 14px;
    }
    .mnh-app .primary:hover{ opacity:.92; }

    .mnh-app .mutedSmall{
      margin-top: 28px;
      font-size: 12px;
      line-height: 1.6;
      color: rgba(255,255,255,.35);
      max-width: 680px;
    }

    .mnh-app .detailsBody{
      padding: 18px;
      display:grid;
      gap: 18px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 980px){
      .mnh-app .detailsBody{ grid-template-columns: 1fr; }
    }
    .mnh-app .box{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.1);
      background:#2a2a2a;
      padding: 14px;
    }
    .mnh-app .label{
      font-size: 12px;
      color: rgba(255,255,255,.6);
      margin-bottom: 8px;
    }
    .mnh-app .input{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.1);
      background:#1f1f1f;
      padding: 12px 12px;
      outline:none;
      font-size: 14px;
    }
    .mnh-app .input:focus{ border-color: rgba(255,255,255,.28); }

    .mnh-app .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .mnh-app .ghost{
      border: 1px solid rgba(255,255,255,.1);
      background: transparent;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
    }
    .mnh-app .ghost:hover{ background: rgba(255,255,255,.08); }

    .mnh-app .pillStatus{
      display:none;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.1);
      color: rgba(255,255,255,.82);
      white-space: nowrap;
    }
    .mnh-app .pillStatus.show{ display:inline-flex; }

    .mnh-app .thumbGrid{
      margin-top: 12px;
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 980px){ .mnh-app .thumbGrid{ grid-template-columns: 1fr; } }

    .mnh-app .videoBox{
      aspect-ratio: 16/9;
      border-radius: 14px;
      overflow:hidden;
      background:#000;
      border: 1px solid rgba(255,255,255,.1);
    }

    .mnh-app .videoBox video, .mnh-app .videoBox img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    .mnh-app .previewVideo{
      width:100%;
      border:0;
      border-radius: 18px;
      overflow:hidden;
    }

    .mnh-app .hint{
      margin-top: 10px;
      font-size: 13px;
      color: rgba(255,255,255,.7);
    }
  </style>
</head>

<body>

<div class="mnh-app">

<header class="topbar">
  <div class="wrap">
    <div class="brand">MyNETHUB</div>

    <div class="searchWrap">
      <div class="searchRow">
        <input id="search" class="searchInput" placeholder="Search" />
        <button id="searchBtn" class="searchBtn" title="Search">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M21 21l-4.3-4.3"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="actions">
      <button id="createBtn" class="pill"><span style="font-size:18px;line-height:0">+</span> Create</button>
      <a class="link" href="/admin/">Dashboard</a>
      <button id="logoutBtn" class="pill">Logout</button>
      <button class="profile" type="button">T</button>

      <div id="createMenu" class="menu">
        <button id="uploadMenuBtn" class="menuItem">
          <span class="menuIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 7H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
              <path d="M22 9l-6 3 6 3V9z"/>
            </svg>
          </span>
          Upload video
        </button>
      </div>
    </div>
  </div>
</header>

<main class="main">
  <section>
    <div class="sectionHead">
      <div class="sectionTitle">Library</div>
      <div id="count" class="count"></div>
    </div>

    <div id="grid" class="grid"></div>

    <div id="empty" class="empty">No videos yet. Click <b>+ Create</b> to upload one.</div>
  </section>
</main>

<!-- Hidden picker -->
<input id="filePicker" type="file" accept="video/*" style="display:none" />

<!-- Select modal -->
<div id="selectModal" class="modal">
  <div class="backdrop"></div>
  <div class="modalCenter">
    <div class="dialog mid">
      <div class="dialogTop">
        <div class="dialogTitle">Upload videos</div>
        <button id="selectClose" class="iconBtn" title="Close">✕</button>
      </div>

      <div class="dialogBodyScroll">
        <div id="dropZone" class="dropZone">
          <div class="bigCircle">
            <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 16V4" />
              <path d="M7 9l5-5 5 5" />
              <path d="M4 20h16" />
            </svg>
          </div>

          <div style="font-size:16px;color:rgba(255,255,255,.9)">Drag and drop video files to upload</div>
          <div style="font-size:13px;color:rgba(255,255,255,.5);margin-top:6px">Your videos will be private until you publish them.</div>

          <button id="selectFilesBtn" class="primary">Select files</button>

          <div class="mutedSmall">
            By submitting your videos, you acknowledge that you agree to the platform terms.
            Please be sure not to violate others' copyright or privacy rights.
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Details modal -->
<div id="detailsModal" class="modal">
  <div class="backdrop"></div>
  <div class="modalCenter">
    <div class="dialog wide">
      <div class="dialogTop">
        <div class="dialogTitle">Details</div>
        <div style="display:flex;align-items:center;gap:10px">
          <div id="uploadStatusPill" class="pillStatus">Processing…</div>
          <button id="detailsClose" class="iconBtn" title="Close">✕</button>
        </div>
      </div>

      <div class="dialogBodyScroll">
        <div class="detailsBody">
          <!-- Left -->
          <div style="display:flex;flex-direction:column;gap:14px">
            <div class="box">
              <div class="label">Title (required)</div>
              <input id="titleInput" class="input" placeholder="Add a title" />
              <div style="margin-top:8px;font-size:12px;color:rgba(255,255,255,.45)">
                File: <span id="fileName" style="color:rgba(255,255,255,.75)"></span>
              </div>
            </div>

            <div class="box">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                <div style="font-weight:700;font-size:14px">Thumbnail</div>
                <div style="font-size:12px;color:rgba(255,255,255,.5)">Pick a frame or upload an image</div>
              </div>

              <div class="thumbGrid">
                <div class="box" style="background:#262626;border-color:rgba(255,255,255,.08)">
                  <div class="videoBox"><video id="pickVideo" muted playsinline></video></div>

                  <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
                    <input id="frameSlider" type="range" min="0" max="1000" value="0" style="width:100%" />
                    <button id="useFrame" class="ghost">Use this frame</button>
                  </div>

                  <div style="margin-top:8px;font-size:12px;color:rgba(255,255,255,.45)">
                    Tip: drag the slider then click “Use this frame”.
                  </div>
                </div>

                <div class="box" style="background:#262626;border-color:rgba(255,255,255,.08)">
                  <div style="font-weight:700;font-size:14px;margin-bottom:10px">Preview</div>

                  <div class="videoBox" style="display:flex;align-items:center;justify-content:center">
                    <img id="thumbPreview" alt="thumb preview" style="display:none;object-fit:cover" />
                    <div id="thumbEmpty" style="font-size:12px;color:rgba(255,255,255,.45)">No thumbnail selected yet</div>
                  </div>

                  <div style="margin-top:12px;font-size:12px;color:rgba(255,255,255,.5)">Or upload any image:</div>
                  <input id="thumbFile" type="file" accept="image/*" class="input" style="margin-top:6px;padding:10px" />

                  <button id="clearThumb" class="ghost" style="margin-top:12px">Clear thumbnail</button>
                </div>
              </div>
            </div>

            <div class="row">
              <button id="changeFileBtn" class="ghost">Change file</button>
              <button id="uploadBtn" class="primary">Upload</button>
            </div>

            <div id="statusText" class="hint"></div>
          </div>

          <!-- Right -->
          <div style="display:flex;flex-direction:column;gap:14px">
            <div class="box">
              <div class="label">Preview</div>
              <div class="videoBox" style="border-radius:18px">
                <video id="previewVideo" class="previewVideo" controls></video>
              </div>
            </div>

            <div class="box" style="font-size:12px;color:rgba(255,255,255,.55)">
              After upload, your video will appear in your Library.
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
const el = (id) => document.getElementById(id);
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",
    '"':"&quot;","'":"&#039;"
  }[m]));
}

/* ========= Header ========= */
el("logoutBtn").addEventListener("click", async () => {
  try { await fetch("/api/admin/logout", { method:"POST" }); }
  finally { location.href = "/admin/login.html"; }
});

const createBtn = el("createBtn");
const createMenu = el("createMenu");

function openCreateMenu(){ createMenu.classList.add("show"); }
function closeCreateMenu(){ createMenu.classList.remove("show"); }

createBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  if (createMenu.classList.contains("show")) closeCreateMenu();
  else openCreateMenu();
});

document.addEventListener("click", (e) => {
  if (createMenu.classList.contains("show")) {
    const inside = createMenu.contains(e.target) || createBtn.contains(e.target);
    if (!inside) closeCreateMenu();
  }
});

/* ========= Library ========= */
const grid = el("grid");
const empty = el("empty");
const countEl = el("count");
const searchEl = el("search");
const searchBtn = el("searchBtn");

let allVideos = [];

async function loadList(){
  const res = await fetch("/api/videos");
  allVideos = await res.json();
  render(allVideos);
}

function render(videos){
  countEl.textContent = videos.length ? `${videos.length} video(s)` : "";
  grid.innerHTML = "";

  if (!videos.length){
    empty.classList.add("show");
    return;
  }
  empty.classList.remove("show");

  grid.innerHTML = videos.map(v => {
    const thumb = v.thumbUrl || "";
    const title = escapeHtml(v.title || v.filename || "");
    return `
      <div class="card" onclick="window.location.href='/watch.html?id=${encodeURIComponent(v.id)}'">
        <div class="thumb">
          ${thumb ? `<img src="${thumb}" alt="thumbnail">` : ""}
        </div>
        <div class="title">${title}</div>
      </div>
    `;
  }).join("");
}

function applySearch(){
  const q = searchEl.value.trim().toLowerCase();
  if (!q) return render(allVideos);
  render(allVideos.filter(v => (v.title || "").toLowerCase().includes(q)));
}
searchEl.addEventListener("input", applySearch);
searchEl.addEventListener("keydown", (e) => { if (e.key === "Enter") applySearch(); });
searchBtn.addEventListener("click", applySearch);

/* ========= Upload flow ========= */
const filePicker = el("filePicker");
const selectModal = el("selectModal");
const detailsModal = el("detailsModal");
const dropZone = el("dropZone");

const titleInput = el("titleInput");
const fileNameEl = el("fileName");
const pickVideo = el("pickVideo");
const previewVideo = el("previewVideo");
const frameSlider = el("frameSlider");
const thumbPreview = el("thumbPreview");
const thumbEmpty = el("thumbEmpty");
const thumbFile = el("thumbFile");
const uploadStatusPill = el("uploadStatusPill");
const statusText = el("statusText");

let selectedVideoFile = null;
let pickedThumbBlob = null;
let pickedThumbName = "thumb.jpg";

function openSelect(){ selectModal.classList.add("show"); }
function closeSelect(){ selectModal.classList.remove("show"); }
function openDetails(){ detailsModal.classList.add("show"); }
function closeDetails(){ detailsModal.classList.remove("show"); }

function clearThumb(){
  pickedThumbBlob = null;
  pickedThumbName = "thumb.jpg";
  thumbPreview.style.display = "none";
  thumbPreview.src = "";
  thumbEmpty.style.display = "block";
  thumbFile.value = "";
}
function resetDetails(){
  titleInput.value = "";
  statusText.textContent = "";
  uploadStatusPill.classList.remove("show");
  uploadStatusPill.textContent = "Processing…";
  clearThumb();
  frameSlider.value = 0;
  pickVideo.removeAttribute("src");
  previewVideo.removeAttribute("src");
  pickVideo.load?.();
  previewVideo.load?.();
}

el("uploadMenuBtn").addEventListener("click", () => {
  closeCreateMenu();
  resetDetails();
  selectedVideoFile = null;
  openSelect();
});

el("selectClose").addEventListener("click", closeSelect);
el("detailsClose").addEventListener("click", closeDetails);

el("selectFilesBtn").addEventListener("click", () => {
  filePicker.value = "";
  filePicker.click();
});

["dragenter","dragover"].forEach(evt => {
  dropZone.addEventListener(evt, (e) => {
    e.preventDefault(); e.stopPropagation();
    dropZone.classList.add("drag");
  });
});
["dragleave","drop"].forEach(evt => {
  dropZone.addEventListener(evt, (e) => {
    e.preventDefault(); e.stopPropagation();
    dropZone.classList.remove("drag");
  });
});
dropZone.addEventListener("drop", (e) => {
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) handleChosenFile(f);
});

filePicker.addEventListener("change", () => {
  const f = filePicker.files && filePicker.files[0];
  if (f) handleChosenFile(f);
});

function handleChosenFile(file){
  if (!file.type.startsWith("video/")) return;
  selectedVideoFile = file;
  fileNameEl.textContent = file.name;

  const url = URL.createObjectURL(file);
  pickVideo.src = url;
  previewVideo.src = url;

  pickVideo.onloadedmetadata = () => {
    frameSlider.value = 0;
    pickVideo.currentTime = 0;
  };

  closeSelect();
  openDetails();
}

el("changeFileBtn").addEventListener("click", () => {
  closeDetails();
  openSelect();
});

frameSlider.addEventListener("input", () => {
  const dur = pickVideo.duration || 0;
  if (!dur) return;
  const pct = Number(frameSlider.value) / 1000;
  pickVideo.currentTime = Math.min(dur - 0.001, dur * pct);
});

el("useFrame").addEventListener("click", async () => {
  if (!pickVideo.videoWidth) return;
  const canvas = document.createElement("canvas");
  canvas.width = pickVideo.videoWidth;
  canvas.height = pickVideo.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(pickVideo, 0, 0);
  const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", 0.9));
  if (!blob) return;
  pickedThumbBlob = blob;
  const url = URL.createObjectURL(blob);
  thumbPreview.src = url;
  thumbPreview.style.display = "block";
  thumbEmpty.style.display = "none";
});

thumbFile.addEventListener("change", () => {
  const f = thumbFile.files && thumbFile.files[0];
  if (!f) return;
  pickedThumbBlob = f;
  pickedThumbName = f.name || "thumb.jpg";
  const url = URL.createObjectURL(f);
  thumbPreview.src = url;
  thumbPreview.style.display = "block";
  thumbEmpty.style.display = "none";
});

el("clearThumb").addEventListener("click", clearThumb);

el("uploadBtn").addEventListener("click", async () => {
  if (!selectedVideoFile){
    statusText.textContent = "Choose a video file first.";
    return;
  }
  const title = titleInput.value.trim();
  if (!title){
    statusText.textContent = "Title is required.";
    return;
  }

  el("uploadBtn").disabled = true;
  el("changeFileBtn").disabled = true;

  uploadStatusPill.classList.add("show");
  uploadStatusPill.textContent = "Uploading…";
  statusText.textContent = "";

  try{
    const fd = new FormData();
    fd.append("video", selectedVideoFile);
    fd.append("title", title);
    if (pickedThumbBlob) fd.append("thumb", pickedThumbBlob, pickedThumbName);

    const res = await fetch("/api/upload", { method:"POST", body: fd });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || "Upload failed");

    uploadStatusPill.textContent = "Done ✅";
    statusText.textContent = "Uploaded ✅";

    await loadList();

    setTimeout(() => {
      closeDetails();
      resetDetails();
      selectedVideoFile = null;
    }, 250);

  }catch(e){
    uploadStatusPill.classList.remove("show");
    statusText.textContent = "Error: " + e.message;
  }finally{
    el("uploadBtn").disabled = false;
    el("changeFileBtn").disabled = false;
  }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape"){
    closeCreateMenu();
    closeSelect();
    closeDetails();
  }
});

/* Start */
loadList();
</script>

</div><!-- /mnh-app -->
</body>
</html>
